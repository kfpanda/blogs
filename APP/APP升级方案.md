# APP升级方案
APP项目当中，经常会碰到版本发布和BUG修复版本发布。每次版本发布都会影响用户体验，操作不好很可能会导致用户的流失。

#### 一、服务端提供版本更新接口。
每次打开客户端时从服务器端获取最新的版本，如果存在最新版本，则可以做以下操作：<br>
1、忽略，不做任何提示。<br>
2、提示版本信息，让用户自行选择是否更新。<br>
3、提示版本信息，并且强制用户更新，如不点击更新则无法使用APP。<br>
此方案更适合版本发布和大版本更新。<br>

#### 二、APP和服务端共同实现PATCH更新方式(热更新方案)。

Android热升级方案：<br>
一、classLoader方案，比较出名的有Ali的AndFix框架。但这些方案并不适用于所有的系统（至少暂时还没解决）。<br>
二、插件化，但此方案需要考虑的细节也极多，暂时没有做出这种方案的Demo。<br>
三、Hybrid开发，此方案也有大致也有两种类型，WebView加载Html页面和React-Native。<br>

第三方公司的方案：<br>
• Native，代表有阿里的Dexposed、AndFix与腾讯的内部方案KKFix；<br>
• Java，代表有Qzone的超级补丁、大众点评的nuwa、百度金融的rocooFix, 饿了么的amigo以及美团的robust。<br>

Iphone热升级方案：<br>

IOS 开发语言 Objective-C 天生动态，运行时都能随意替换方法，运行时加载动态库又是项很老的技术。我们只要把增量的代码和资源打包到一个 framework 里，动态下发运行时加载、修bug、加功能都不在话下，性能完全无损这件事就结束了。
可惜的是苹果把加载动态库的功能给封了，动态库必须跟随安装包一起签名才能被加载，无法通过别的途径签名后再下发。<br>

所以才会出现现在的 waxPatch 和 JSPatch 这样的方案，以及异军突起不局限于热修复Bug而能做主体功能发布的React Native 和 Weex。

## 服务端的设计思路
APP应用属于一种C/S架构的，经常会出现多版本同事在线的情况，这样对于服务端的开发带来很大的麻烦。<br>

服务端常用的设计方式：<br>
1、数据库层面尽量采用新增字段，而不是修改字段的原则，这样可以更好的兼容原先版本。<br>
2、API层尽量设计灵活，接入层可以支持“路由”最佳。<br>

主要有几种思路：
1. 在API方法中通过新增参数或者直接新增API方法（也可以理解为重载）。
  较少的改动可以这样去做处理，但是改动多了会比较麻烦，不利用扩展。<br>
2. 代码分不同分支版本，API部署不同子站点。通过api.xxxx.com/V1和api.xxxx.com/V2方式访问或者apiV1.xxxx.com，apiV2.xxxx.com等方式区分访问。
当然，也可以在APP不同版本中请求时传入标识，服务端通过Nginx或者APIGateWay等来实现服务路由。这种直观上更加清晰，工作量也会大一些，会增加一定的维护和管理成本。<br>

如果大版本更新，改动较多，则必须得强制升级。一般IOS APP先到APP Store提审，等待审核通过和Android一起发布。<br>
主要的工作流程：
1. 部署1个具有新表结构和对象的测试数据库（预发布环境）。 <br>
2. 部署1个新的API站点（不同域名，建议域名中使用版本号区分。或者采用不同子站点的方式），配置连接测试库和测试的（API站点、DB、缓存、ES、Nosql …这些单独有一套预发布环境）<br>
3. 等苹果审核通过之后，更新最新的程序，数据库结构等到生产环境，并将API地址的域名的指向切换到生产环境中（网站、admin后台等等可以直接发布了），运营人员在苹果商店点击上架操作，服务端升级完成（APP端会有强制更新的提示）。当然，这个过程中可能会造成短暂的停机时间，所以一般是选择在晚上操作。<br>
4. 提前将安卓最新APK放到我们的下载站或镜像站，在3步服务端程序等都发布完成后，在运营后台开启安卓版本的强制升级提示（从我们的下载站或者镜像站下载APK升级）。 <br>
这样，旧版本的安卓用户，会强制升级到新的版本，不会影响到使用。 <br>
与此同时，运营人员也需要在各大安卓市场去分发和上架最新的apk包，提供最新的其他渠道下载，避免用户下载到旧程序，然后又提示强制升级影响体验。<br>

## APP版本开发和升级频率

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APP首个版本或者大版本开发时相对来说时间较长。研发和产品经理等在需求评审时设置好里程碑计划（尽量不超过3个），在每个里程碑（最长不超过1周）时间点。<br>
产品经理和项目经理需要确认完成的情况，发现问题及时调整研发计划，控制项目风险，保证项目如期完成。<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APP后期版本迭代开发，每个版本最好有一个重要的功能，版本研发周期最好控制在2周-3周内（如果只涉及服务器端的功能新增，则可以1周发一版本）。<br>
一方面保证项目团队良好的开发节奏，使研发效率最大化。另一方面保证每个版本有新东西给到用户体验，避免用户的频繁升级带来体验差效果。<br>
当然大版本开发时需要保证系统上线后的稳定性，可以将研发周期延至1个月或者进行灰度发布。<br>
要尽量避免安排超过一个月研发周期的版本，否则项目延期的风险较大。可以将长版本设置为若干个里程碑版本发布（经验来看研发周期过长往往会导致研发技术人员精力分散，工作拖沓，积极性下降。）。<br>
版本发布时间最好选择周三周四，可以更好保证项目发布后的支撑工作。<br>
线上APP版本最好不要超过4个，维护老版本成本还是比较高的，比如做新功能还要考虑新老版本兼容情况和各种后台数据接口升级、更新的兼容问题等。<br>


## 引用
> APP版本规划：http://www.pmcaff.com/article?id=2000000000007697 <br>
> App升级方案：http://www.pmcaff.com/article?id=2000000000007702<br>
> 热升级方案：http://www.cnblogs.com/Creator/p/7007694.html<br>